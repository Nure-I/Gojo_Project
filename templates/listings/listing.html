{% extends 'base.html' %}

{% load humanize %}

{% block title %} | {{ listing.title }} {% endblock %}

{% block content %}
<section id="showcase-inner" class="py-5 text-white">
    <div class="container">
        <div class="row text-center">
            <div class="col-md-12">
                <h1 class="display-4">{{ listing.title }}</h1>
                <p class="lead">
                    <i class="fas fa-map-marker"></i> {{ listing.city }} {{ listing.state }}, {{ listing.zipcode }}</p>
            </div>
        </div>
    </div>
</section>

<!-- Breadcrumb -->
<section id="bc" class="mt-3">
    <div class="container">
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{% url 'index' %}">Home</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'listings' %}">Listings</a>
                </li>
                <li class="breadcrumb-item active">{{ listing.title }}</li>
            </ol>
        </nav>
    </div>
</section>

<!-- Alerts -->
{% include 'partials/_alerts.html' %}

<!-- Listing -->
<section id="listing" class="py-4">
    <div class="container">
        <a href="{% url 'listings' %}" class="btn btn-light mb-4">Back To Listings</a>
        <div class="row">
            <div class="col-md-9">
                <!-- Home Main Image -->
                <img src="{{ listing.photo_main.url }}" alt="" class="img-main img-fluid mb-3">
                <!-- Thumbnails -->
                <div class="row mb-5 thumbs">
                    {% if listing.photo_1 %}
                    <div class="col-md-2">
                        <a href="{{ listing.photo_1.url }}" data-lightbox="home-images">
                            <img src="{{ listing.photo_1.url }}" alt="" class="img-fluid">
                        </a>
                    </div>
                    {% endif %}
                    {% if listing.photo_2 %}
                    <div class="col-md-2">
                        <a href="{{ listing.photo_2.url }}" data-lightbox="home-images">
                            <img src="{{ listing.photo_2.url }}" alt="" class="img-fluid">
                        </a>
                    </div>
                    {% endif %}
                    {% if listing.photo_3 %}
                    <div class="col-md-2">
                        <a href="{{ listing.photo_3.url }}" data-lightbox="home-images">
                            <img src="{{ listing.photo_3.url }}" alt="" class="img-fluid">
                        </a>
                    </div>
                    {% endif %}
                    {% if listing.photo_4 %}
                    <div class="col-md-2">
                        <a href="{{ listing.photo_4.url }}" data-lightbox="home-images">
                            <img src="{{ listing.photo_4.url }}" alt="" class="img-fluid">
                        </a>
                    </div>
                    {% endif %}
                    {% if listing.photo_5 %}
                    <div class="col-md-2">
                        <a href="{{ listing.photo_5.url }}" data-lightbox="home-images">
                            <img src="{{ listing.photo_5.url }}" alt="" class="img-fluid">
                        </a>
                    </div>
                    {% endif %}
                    {% if listing.photo_6 %}
                    <div class="col-md-2">
                        <a href="{{ listing.photo_6.url }}" data-lightbox="home-images">
                            <img src="{{ listing.photo_6.url }}" alt="" class="img-fluid">
                        </a>
                    </div>
                    {% endif %}
                </div>
                <!-- Fields -->
                <div class="row mb-5 fields">
                    <div class="col-md-6">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item text-secondary">
                                <i class="fas fa-money-bill-alt"></i> Asking Price:
                                <span class="float-right">{{ listing.price | intcomma }} ETB {{ listing.price_term }} </span>
                            </li>
                            <li class="list-group-item text-secondary">
                                <i class="fas fa-bed"></i> Bedrooms:
                                <span class="float-right">{{ listing.bedrooms }}</span>
                            </li>
                            <li class="list-group-item text-secondary">
                                <i class="fas fa-bath"></i> Bathrooms:
                                <span class="float-right">{{ listing.bathrooms }}</span>
                            </li>
                            <li class="list-group-item text-secondary">
                                <i class="fas fa-car"></i> Garage:
                                <span class="float-right">{{ listing.garage }}</span>
                            </li>
                            <li class="list-group-item text-secondary">
                                <i class="fas fa-award"></i> Owner:
                                <span class="float-right">{{ listing.owner.first_name }} {{ listing.owner.last_name }}</span>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item text-secondary">
                                <i class="fas fa-th-large"></i> Square Feet:
                                <span class="float-right">{{ listing.sqft }}</span>
                            </li>
                            <li class="list-group-item text-secondary">
                                <i class="fas fa-square"></i> Lot Size:
                                <span class="float-right">{{ listing.lot_size }} Acres
                  </span>
                            </li>
                            <li class="list-group-item text-secondary">
                                <i class="fas fa-calendar"></i> Listing Date:
                                <span class="float-right">{{ listing.list_date }}</span>
                            </li>
                            <li class="list-group-item text-secondary">
                                <i class="fas fa-bed"></i> Realtor:
                                <span class="float-right">{{ listing.realtor }}
                  </span>
                            </li>


                        </ul>
                    </div>
                </div>

                <!-- Description -->
                <div class="row mb-5">
                    <div class="col-md-12">
                        {{ listing.description }}
                    </div>
                </div>

                <!--                &lt;!&ndash;Google map&ndash;&gt;-->
                <!--                <div id="map-container-google-3" class="z-depth-1-half map-container-3">-->
                <!--                   <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d1754.8728440654145!2d38.73914577186017!3d8.993566998858977!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zOMKwNTknMzYuOCJOIDM4wrA0NCcyNC4yIkU!5e1!3m2!1sen!2sus!4v1629947369244!5m2!1sen!2sus"-->
                <!--                    width="1000" height="450" style="border:0;" allowfullscreen="" loading="lazy"></iframe>-->
                <!--                </div>-->

                <!--                &lt;!&ndash;Google Maps&ndash;&gt;-->
            </div>
            <div class="col-md-3">
                <div class="card mb-3">
                    <img class="card-img-top" src="{{ listing.realtor.photo.url }}" alt="">
                    <div class="card-body">
                        <h5 class="card-title">Property Realtor</h5>
                        <h6 class="text-secondary">{{ listing.realtor }}</h6>
                    </div>
                </div>
                {% if is_realtor %}
                    {% if realtor == listing.realtor %}
                        {% if listing.is_published %}
                            <button class="btn-danger btn-block btn-lg" data-toggle="modal" data-target="#deleteModal">
                                Delete Post
                            </button>
                        {% else %}
                            <button class="btn-info btn-block btn-lg" data-toggle="modal" data-target="#postModal">
                                Post House
                            </button>
                        {% endif %}
                    {% else %}
                    <button class="btn-primary btn-block btn-lg" data-toggle="modal" data-target="#inquiryModal">Make An
                        Inquiry
                    </button>

                    {% endif %}
                {% elif owner %}
                    {% if listing.is_published %}
                        <button class="btn-danger btn-block btn-lg" data-toggle="modal" data-target="#deleteModal">
                                    Delete
                        </button>
                    {% else %}
                        <button class="btn-info btn-block btn-lg" data-toggle="modal" data-target="#postModal">
                            Post House
                        </button>
                    {% endif %}
                {% elif customer %}
                    {% if contact.requested == 'Request Accepted' %}
                        {% if contact.paid == True %}
                            {% if listing.listed_for == 'For Sell' %}
                            <button class="btn-secondary btn-block btn-lg" data-toggle="modal" data-target="">SOLD
                            </button>
                            {% else %}
                            <button class="btn-secondary btn-block btn-lg" data-toggle="modal" data-target="#">RENTED
                            </button>
                            {% endif %}
                        {% else %}
                            <button class="btn-secondary btn-block btn-lg" data-toggle="modal" data-target="#yenepayModal">YenePay
                            </button>
                            <hr>
                            <div id="paypal-button-container"></div>
                            <hr>
                            <button class="btn-light btn-block btn-lg" data-toggle="modal" data-target="#yenepayModal">Pay With Bank
                            </button>
                        {% endif %}
                    {% else %}
                        <button class="btn-primary btn-block btn-lg" data-toggle="modal" data-target="#inquiryModal">Make An
                            Inquiry
                        </button>
                    {% endif %}
                {% else %}
                    <button class="btn-primary btn-block btn-lg" data-toggle="modal" data-target="#inquiryModal">Make An
                        Inquiry
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
</section>
<!-- Inquiry Modal -->

<div class="modal fade" id="inquiryModal" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inquiryModalLabel">Make An Inquiry</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form action="{% url 'contact' %}" method="POST">
                    {% csrf_token %}
                    {% if user.is_authenticated %}
                    <input type="hidden" name="user_id" value="{{ user.id }}">
                    {% else %}
                    <input type="hidden" name="user_id" value="0">
                    {% endif %}
                    <input type="hidden" name="realtor_email" value="{{ listing.realtor.email }}">
                    <input type="hidden" name="listing_id" value="{{ listing.id }}">
                    <div class="form-group">
                        <label for="property_name" class="col-form-label">Property:</label>
                        <input type="text" name="listing" class="form-control" value="{{ listing.title }}">
                    </div>
                    <div class="form-group">
                        <label for="name" class="col-form-label">Name:</label>
                        <input type="text" name="name" class="form-control" {% if user.is_authenticated %}
                               value="{{ user.first_name }} {{ user.last_name }}" {% endif %} required>
                    </div>
                    <div class="form-group">
                        <label for="email" class="col-form-label">Email:</label>
                        <input type="email" name="email" class="form-control" {% if user.is_authenticated %}
                               value="{{ user.email }}" {% endif %} required>
                    </div>
                    <div class="form-group">
                        <label for="phone" class="col-form-label">Phone:</label>
                        <input type="text" name="phone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="message" class="col-form-label">Message:</label>
                        <textarea name="message" class="form-control"></textarea>
                    </div>
                    <hr>
                    <input type="submit" value="Send" class="btn btn-block btn-secondary">
                </form>
            </div>
        </div>
    </div>
</div>

<!--# Deleting or unpublished-->

<div class="modal fade" id="deleteModal" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Are You Sure?</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>

                <form action="{% url 'delete' %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="listing_id" value="{{ listing.id }}">
                    <hr>
                    <input type="hidden" name="listing" value="{{ listing.title }}">
                    <hr>
                    <button type="button" class="btn btn-block btn-secondary" data-dismiss="modal">
                        Cancel
                    </button>
                    <input type="submit" value="Delete" class="btn-danger btn-block btn-lg">
                </form>


            </div>
        </div>
    </div>
</div>
<!--# Post listing or publish -->

<div class="modal fade" id="postModal" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="postModalLabel">Are You Sure?</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
                <form action="{% url 'post' %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="listing_id" value="{{ listing.id }}">
                    <hr>
                    <input type="hidden" name="listing" value="{{ listing.title }}">
                    <hr>
                    <button type="button" class="btn btn-block btn-danger" data-dismiss="modal">
                        Cancel
                    </button>
                    <input type="submit" value="Post" class="btn-success btn-block btn-lg">
                </form>
            </div>
        </div>
    </div>
</div>
<!--# Yenepay-->

<div class="modal fade" id="yenepayModal" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
<!--                <h4 class="modal-title" id="yenepayModalLabel">{{listing.title}}</h4><br>-->
                <img src="{{ listing.photo_main.url }}" alt="" width="20px" height="150px"><br>
<!--                <h7 class="modal-title" id="yenepayModalLabel">{{listing.title}}</h7>-->
<!--                <button type="button" class="close" data-dismiss="modal">-->
<!--                    <span>&times;</span>-->
<!--                </button>-->

                <form action="https://test.yenepay.com" method="POST" target="_blank">
                    {% csrf_token %}
                    {% for name,value in yenepay.items %}
                    <input type="hidden" name="{{ name }}" value="{{ value }}">

                    {% endfor %}
                    {{listing.title}}<br> {{listing.price}} ETB + 2% (Service Pay) <br>
                    Total: {{Total_pay}}
                    <input type="submit" value="Pay with YenePay" class="btn-success btn-block btn-lg">
                    <button type="button" class="btn btn-block btn-danger" data-dismiss="modal">
                        Cancel
                    </button>

                </form>


            </div>
        </div>
    </div>
</div>
 <script src="https://www.paypal.com/sdk/js?client-id=AXahcq9YrJSG5Jp0Ch78THwr0tO815mJPX_vSRejwp-vHPq2X9r4lyLm4Bg07pajlL6YwE1Cx9sQ2c-F&currency=ETB"></script>
<script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
        var price = '{{listing.price}}'
        var listingId = '{{contact.listing_id}}'

        function completeOrder(){
        var url = "{% url 'complete' %}"

        fetch(url, {
            method:'POST',
            headers:{
                'Content-type':'application/json',
                'X-CSRFToken':csrftoken,
                },
                body:JSON.stringify({'listingID':listingId})
            })
        }
        // Render the PayPal button into #paypal-button-container
        paypal.Buttons({

            // Set up the transaction
            createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: price
                        }
                    }]
                });
            },

            // Finalize the transaction
            onApprove: function(data, actions) {
                return actions.order.capture().then(function(orderData) {
                    // Successful capture! For demo purposes:
                    completeOrder()
                    console.log('Capture result', orderData, JSON.stringify(orderData, null, 2));
                    var transaction = orderData.purchase_units[0].payments.captures[0];
                    alert('Transaction '+ transaction.status + ': ' + transaction.id + '\n\nCheck Your Email For More Info');

                    // Replace the above to show a success message within this page, e.g.
                    // const element = document.getElementById('paypal-button-container');
                    // element.innerHTML = '';
                    // element.innerHTML = '<h3>Thank you for your payment!</h3>';
                    // Or go to another URL:  actions.redirect('thank_you.html');
                });
            }


        }).render('#paypal-button-container');
    </script>
{% endblock %}